{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome","text":"<p>Welcome to my blog! I hope you will find here a lot of interesting information related to Open Source and Cloud Native technologies.</p>"},{"location":"#what-is-this-blog-about","title":"What is this blog about ?","text":"<p>The main goal of this blog is to document my personal journey of setting up my home lab. This lab is going to play a role of my private cloud. The idea is to share with others like you, how to use the most up to date Cloud Native Open Source tools to build your home cloud </p>"},{"location":"#assumptions","title":"Assumptions","text":"<p>The main assumptions of my project are:</p> <ul> <li>It should be not very expensive.</li> <li>All the available programs and solutions must be Open Source.</li> <li>The solution must be as much automated as possible.</li> <li>The Infrastructure as a Code as well as GitOps is playing the central role.</li> <li>The Kubernetes is always in the hearth of the proposed solutions.</li> </ul>"},{"location":"#final-words","title":"Final words","text":"<p>If you enjoy my blog, I would be very happy if you share it with your colleagues and help me spread this knowledge. You can also leave a comments if you found something not clear, bad or just want to discuss different approaches. Thanks for visiting! </p>"},{"location":"about/","title":"k8sky.dev","text":"<p>More about me soon.. :)</p>"},{"location":"hardware/costs/","title":"Costs","text":"<p>For those who are interested in overall costs of my solution, I summarize everything in this page. The list does not include extra peripherals (like network cables, keyboards or monitors).</p>"},{"location":"hardware/costs/#summary","title":"Summary","text":"Item Price Date of purchase Proctli Vault VP2420 + WiFi Kit 358 \u20ac 2023/12/18 Crucial 32GB SODIMM DDR4 329.99 PLN (75 \u20ac) 2023/12/18 Western Digital Blue SA510 SSD 329.99 PLN (75 \u20ac) 2023/12/18 Raspberry Pi 4B 8GB 515 PLN (117 \u20ac) 2023/08/22 Geekworm KVM-A3 425.89 PLN (97 \u20ac) 2023/08/24 Sum 722 \u20ac"},{"location":"hardware/pikvm-a3/","title":"PiKVM-A3","text":"<p>PiKVM is KVM over IP solution build on Raspberry PI. It helps me to remotely manage my Vault Protectli VP2420 server. </p> <p>You can find more details about the project at its official webpage PiKVM</p>"},{"location":"hardware/pikvm-a3/#raspberry-pi-4","title":"Raspberry Pi 4","text":"<p>The solution is build on Raspberry Pi 4 model B with 8GB of memory. I think there is nothing more to add here as the Raspberry Pi is well known and if you want to learn more, you can search in google.</p>"},{"location":"hardware/pikvm-a3/#geekworm-kvm-a3","title":"Geekworm KVM-A3","text":"<p>This Kit allows to build the PiKVM with Raspberry Pi 4. The KVM-A3 is composed of following parts:</p> <ul> <li>KVM-A3 Metal Case for Raspberry Pi 4</li> <li>X630 HDMI to CSI-2 Module (for video capture)</li> <li>X630-A3 Expansion Board (for ethernet, cooling, RTC, power in etc)</li> <li>X630-A5 Adapter Board (it is installed inside the PC case, and it connect the computer motherboard and IO panel cabe of PC case)</li> <li>0.96 inch OLED (for display, Resolution: 128\u00d764 pixel)</li> <li>Ethernet Cable (TIA/EIA-568.B connection, and it's ATX control signal cable)</li> </ul> <p>For more details refer to https://wiki.geekworm.com/PiKVM-A3</p> <p></p>"},{"location":"hardware/pikvm-a3/#how-it-works","title":"How it works","text":"<p>In an nutshell - the PiKVM must be connected to server via the HDMI cable to transfer the video and USB-C OTG cable to computer to emulate both keyboard + mouse. Of course the RPi must be connected to the network. Once you know the IP, you simply visit the web interface and you can start remotely control your server (reboot, enter bios etc.).</p> <p></p>"},{"location":"hardware/protectli-vp2420/","title":"Protectli Vault","text":""},{"location":"hardware/protectli-vp2420/#the-beginning","title":"The beginning","text":"<p>It's been a long time since I started to look for a computer which will help me build my home lab. It wasn't easy task, mainly due to my high expectations. I wanted to have something which will help me to host my media applications, storage server, smart home solutions and many many more. I thought that Raspberry PI will be ideal solution. However it turns out that I need to modernize also my network by buying extra routers, AP etc. Also, I would need some dedicated solution for the storage (there I thought that some NAS device will be a good choice). Another option was to buy few used micro / tiny PCs (which are available with decent price) and use them to built Kubernetes cluster. The number of ideas were growing and my mind was blown with number of possible options.</p>"},{"location":"hardware/protectli-vp2420/#protectli-vault","title":"Protectli Vault","text":"<p>One day I found a really nice video from Techno Tim My Mobile HomeLab!. He presented there his new Mobile HomeLab based on Protectli Vault. It was the very first time I've seen this company and their products. After reading a few more articles and their official webpage Knowledge Base, I've decided to give it a try. It took me a while to select the proper product from the list. But Finally I decided on Protectli Vault VP2420.</p>"},{"location":"hardware/protectli-vp2420/#vp2420","title":"VP2420","text":"<p>The device comes with:</p> <ul> <li>4x 2.5G Port</li> <li>Intel Celeron J6412 Quad Core at 2GHz</li> <li>M.2 SATA SSD Slot</li> <li>16 GB eMMC module on board</li> </ul> <p>More details at official product page VP2420 </p> <p>You can decide on buying the device together with extra components (like Memory, Storage M2 or SATA, TPM, WiFi, 4G/5G Modem). You can also select the BIOS (between AMI &amp; coreboot), Power Cable, or Labels. I've decided to buy just a core device, together with WiFi Module to make sure I've used the supported device. I've selected also coreboot BIOS and EU Power Cable. The rest necessary components I've bought on my local market.</p> <p>I placed an order a week before Christmas and fortunately got it in my home in about 4 working days (shipped from Germany). </p> <p>It came to me with the box labeled with PROTECTLI Brand and model details as seen on below picture:</p> <p></p> <p>In the front after unboxing we can see 4x NIC Ports together with WiFi antennas mount points and power plug socket.</p> <p></p> <p>In the back we have a number of ports for different interfaces, like:</p> <ul> <li>HDMI</li> <li>DisplayPort</li> <li>USB (A &amp; C)</li> <li>SIM Card slot</li> <li>Serial Port</li> </ul> <p>And of course power button.</p> <p></p>"},{"location":"hardware/protectli-vp2420/#assembly","title":"Assembly","text":"<p>As I mentioned before, I've ordered a core device without memory and storage. Thus I bought them extra from my local suppliers. You can find the list of supported devices on the official Protectli webpage Vault Hardware Compatibility.</p> <p>I decided to buy:</p> <ul> <li>Western Digital Blue SA510 (1TB SSD Drive) Amazon</li> </ul> <p></p> <ul> <li>Crucial 32GB DDR4 SODIMM (CT32G4SFD832A) Amazon</li> </ul> <p></p> <p>So it is time to assmembly everything together. First I had to open the bottom cover. This is how it looked originally. The WiFi Kit was partially assembled (cables were not connected to WiFi card).</p> <p></p> <p>Adding Memory and M2.SSD disk were easy, however the WiFi antennas cables got constantly unplugged. I was a bit tricky to connect them properly and mount M2.SSD on top of WiFi card. But finally I made it :).</p> <p>Here is the final result:</p> <p></p> <p>And with assembled antennas:</p> <p></p>"},{"location":"hardware/protectli-vp2420/#first-start","title":"First Start","text":"<p>To start the Vault all we need is monitor with HDMI or DisplayPort cable + keyboard. By default the Vault will try to boot using network (PXE). We can click either DEL to enter the BIOS or F11 to enter the Boot Manager Menu. From the list we can choose between:</p> <ul> <li>Network Boot and Utilities</li> <li>UEFI Shell</li> <li>eMMC Device</li> </ul> <p>The coreboot BIOS is quite easy to use. </p> <p></p> <p>The Vault is very quite cause it is fanless device. It was one of the main factor for when choosing the correct computer for my Homelab.</p> <p>In the next sections I will be writing more about the Protectli Vault VP2420, focusing more on software installation and configuration. </p>"},{"location":"software/openwrt/","title":"OPNsense","text":""},{"location":"software/openwrt/#wifi-access-point","title":"WiFi Access Point","text":"<p>I bought my Protectli VP2420 device with extra WiFi Kit Protectli M.2 802.11ac WiFi Kit. I wanted to have all-in-one solution with WiFi included. Because, the BSD like systems does not support a lot of WiFi Chipsets (due to lack of drivers), configuring WiFi module based on Qualcomm Atheros QCA6174A-5 was not an option on OPNsense. I was disappointed about it. But there are alternative solutions, like OpenWrt which supports it. However, installing and configuring it is not a piece of cake. More on it in further reading. </p>"},{"location":"software/openwrt/#openwrt","title":"OpenWrt","text":"<p>The OpenWrt is well known, open source embedded operating system based on Linux. It's common alternative system for WiFi home Routers &amp; Access Points which supports it. It comes with a number of options to configure your WiFi environment. It can be configured with both CLI or UI (Luci). Protectli created a nice tutorial about configuring and installing OpenWRT on the Vault. </p> <p>How to Configure Protectli Wifi Kit in OpenWrt on the Vault</p>"},{"location":"software/openwrt/#vm-configuration","title":"VM Configuration","text":"<p>I want to configure OpenWrt as Virtual Machine on Proxmox (LXC containers does not support physical devices passthrough). I found a nice article about the procedure https://i12bretro.github.io/tutorials/0405.html, but decided to improve it by using Tofu for VM creating and configuration.</p> <p>The VM will have single vNIC bridged to LAN subnet (vmbr1) and physical WLAN interface mapped from Protectli device. See below diagram for more info:</p> <p></p> <p>Here is my VM resource configured with the help of Tofu</p> <pre><code>resource \"proxmox_virtual_environment_vm\" \"openwrt\" {\n  name        = \"openwrt\"\n  description = \"OpenWRT WiFi AP\"\n  tags        = [\"network\"]\n\n  node_name = var.node\n  vm_id     = 101\n\n  cpu {\n    type = \"host\"\n  }\n\n  hostpci {\n    device = \"hostpci0\"\n    id = \"0000:05:00.0\"\n    rombar = true\n  }\n\n  memory {\n    dedicated = 256\n  }\n\n  network_device {\n    bridge = \"vmbr1\"\n  }\n\n  operating_system {\n    type = \"l26\"\n  }\n\n  tablet_device = false\n  on_boot = false\n\n  boot_order = [\"scsi0\",\"net0\",\"hostpci0\"]\n}\n</code></pre> <p>The VM has been created without any hard drive for the purpose. I had to prepare and import disk with latest OpenWrt image as described in previously mentioned article. The below command needs to be run from the Proxmox host shell:</p> <pre><code>latestVersion=23.05.2\nwget -O openwrt.img.gz https://downloads.openwrt.org/releases/$latestVersion/targets/x86/64/openwrt-$latestVersion-x86-64-generic-ext4-combined.img.gz\ngunzip ./openwrt.img.gz\nmv ./openwrt*.img ./openwrt.raw\nqemu-img resize -f raw ./openwrt.raw 512M\nqm importdisk 102 openwrt.raw ssd-m2\n</code></pre> <p>Once the disk is imported and attached to OpenWrt VM, it needs to be attached into it. Just double click on the disk from the Hardware tab and confirm with OK. Now we can start the VM and wait a while for the system for the first boot.</p>"},{"location":"software/openwrt/#system-configuration","title":"System Configuration","text":"<p>The very first step is to set new root password by running the command:</p> <pre><code>passwd\n</code></pre> <p>This password will be used later to access the Luci UI.</p> <p>Next, configure the Interface IP Address, Default Gateway and DNS to allow access to the Internet. We are going to point to our OPNSense instance which plays a role of Firewall Gateway and temporary DNS:</p> <pre><code>uci set network.lan.ipaddr='192.168.1.2' \nuci set network.lan.gateway='192.168.1.1' \nuci set network.lan.dns='192.168.1.1' \nuci commit\nservice network restart\nopkg update\n</code></pre> <p>Once the connection is working, we need to install additional packages with drivers and software for our WiFi Kit:</p> <pre><code>opkg install hostapd \nopkg install ath10k-firmware-qca6174  \nopkg install kmod-ath10k\n</code></pre> <p>Finally, update the firmware to allow OS recognize the interface.</p> <pre><code>wget https://kb.protectli.com/wp-content/uploads/sites/9/2023/06/wifi-fix-standalone-0.3.1.tar.gz -O /tmp/wifi-fix-standalone-0.3.1.tar.gz \ncd /tmp \ntar zxf wifi-fix-standalone-0.3.1.tar.gz  \ncp -rp /tmp/wifi-fix-standalone/vendor/* /lib/firmware/ath10k/QCA6174/hw3.0/ \nreboot\n</code></pre> <p>After the reboot, we can see that wlan0 interface appeared on the list of interfaces.</p> <p></p>"},{"location":"software/openwrt/#openwrt-configuration","title":"OpenWrt Configuration","text":"<p>In order to get access to OpenWRT, you need to have access to LAN network where OpenWrt VM is hosted. For me the best way was to create a tiny VM with minimal linux which has a browser and connect to Luci UI from there. In the next steps, I will show the minimum number of steps required to configure basic WiFi network with access to LAN behind OPNsense. For more advanced config, please refer to official project documentation.</p> <ol> <li>Login to Web UI using address https://192.168.1.2 and accept not trusted SSL Certificate.</li> <li>Go to Network tab and select Wireless.</li> <li>Here you should see your radio0 device and default WiFi \"OpenWRT\" network. </li> <li>Edit the first available network and adjust at minimum ESSID value in General Setup tab + set the Encryption + key in Wireless Security tab.  </li> <li>Save and Click on Enable button next to the previously edited interface. </li> </ol> <p>After that, you can see your new network being broadcasted. Just login and enjoy it!</p>"},{"location":"software/openwrt/#summary","title":"Summary","text":"<p>The configuration does not work out of the box. As you can see, the process requires a couple of non-trivial steps. With that being said, I must say I'm a bit disappointed. The signal is not a superpower. What is more, I would prefer to configure this WiFi on an OPNsense VM and not host another one and maintain it just for WiFi Management. I will think of maybe a dedicated WiFi device in the near future as an extension of my lab network.</p>"},{"location":"software/opnsense/","title":"Firewall","text":""},{"location":"software/proxmox-ve/","title":"Proxmox VE","text":""},{"location":"software/proxmox-ve/#introduction","title":"Introduction","text":"<p>I decided to use Proxmox VE for my Protectli Virtualization Platform. The main reason was ease of setup and good support and documented deployments from Protectli. I'm sure it is going to meet all my home lab requirements. There tons of documents in the Internet with tutorials for Proxmox. That was another reason of choosing this OS software.</p>"},{"location":"software/proxmox-ve/#installation","title":"Installation","text":"<p>Normally, the Proxmox VE installation is very trivial. It is based on Debian Linux and comes with really handy installer. You simply need to download the official ISO file from the Proxmox website and prepare the USB stick. </p> <p>However, with my Protectli I had few challenges. Mainly because I wanted to use its 8GB eMMC Storage for the purpose of OS installation. During installation, I was able to select my eMMC storage however the installer was failing with an error:</p> <pre><code>Unable to get device for partition 1 on device /dev/mmcblk0\n</code></pre> <p>Luckily I found this article Install Proxmox VE on eMMC, which helped me address the issue. It seems Proxmox and its installer do not like /dev/mmcblk* devices, probably considering the eMMC as not good place for hosting the OS. </p>"},{"location":"software/proxmox-ve/#post-installation","title":"Post-Installation","text":"<p>There were a few things to be configured after the installation like: - Configure necessary repositories (By default Proxmox uses the ones which requires subscription. I wanted to stay with OS only). - Install basic packages (VIM) - Update GRUB to enable PCI-Passthrough/IOMMU - etc.</p> <p>And of course the VMs or LXC containers. As I told at the beginning, the infrastructure I build must be IaC controller. Here the OpenTofu comes with the help.</p>"},{"location":"software/proxmox-ve/#opentofu","title":"OpenTofu","text":"<p>Yes! I'm going to use OpenTofu instead of Terraform. The idea of this project is to use only Open Source tools. Unfortunately, recent HashiCorp decision of changing the Terraform license to BSL is turning it out of Open Source communities.</p> <p>There are few providers available for OpenTofu which can help with configuring the Proxmox. Unfortunately, they are not very well. They lack a lot of options and are usually limited only to few simple settings. I decided to let go with the following one:</p> <p>There is a provider for Proxmox. Unfortunately, it is limited to provision only VMs or LXC containers. Not much, but better this than nothing. Its documentation describes how to start by creating the necessary Role, User, and API Key.</p> <p>Proxmox Provider for Terraform</p> <p>I'm going to use it with OpenTofu to provision necessary VMs for the purpose of my future applications and Kubernetes cluster, but also to configure the Proxmox node.</p> <p>The code of my OpenTofu configuration can be found on my GitHub repo: https://github.com/andrewkaczynski/homelab-tofu.</p> <p>In order to start using the Proxmox provider, the basic minimum is to configure the terraform block and set the required providers:</p> <pre><code>terraform {\n    required_providers {\n        proxmox = {\n            source = \"bpg/proxmox\"\n            version = \"0.43.3\"\n        }\n    }\n}\n</code></pre> <p>And configure the necessary provider options:</p> <pre><code>provider \"proxmox\" {\n    endpoint = \"https://192.168.18.100:8006/\"\n    # I don't have trusted certificate installed on my proxmox node\n    insecure = true\n}\n</code></pre> <p>The credentials are passed thanks to the following two environment variables:</p> <pre><code>export PROXMOX_VE_USERNAME=root@pam\nexport PROXMOX_VE_PASSWORD=mysupersecretpassword\n</code></pre> <p>Let's initialize the OpenTofu project first.</p> <pre><code>$ tofu init\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding bpg/proxmox versions matching \"0.43.0\"...\n- Installing bpg/proxmox v0.43.0...\n- Installed bpg/proxmox v0.43.0 (signed, key ID DAA1958557A27403)\n\nProviders are signed by their developers.\nIf you'd like to know more about provider signing, you can read about it here:\nhttps://opentofu.org/docs/cli/plugins/signing/\n\nOpenTofu has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that OpenTofu can guarantee to make the same selections by default when\nyou run \"tofu init\" in the future.\n\nOpenTofu has been successfully initialized!\n\nYou may now begin working with OpenTofu. Try running \"tofu plan\" to see\nany changes that are required for your infrastructure. All OpenTofu commands\nshould now work.\n\nIf you ever set or change modules or backend configuration for OpenTofu,\nrerun this command to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to do so if necessary.\n</code></pre> <p>Then create the very first resource, e.g. proxmox_virtual_environment_cluster_options</p> <pre><code>resource \"proxmox_virtual_environment_cluster_options\" \"options\" {\n  language                  = \"en\"\n  keyboard                  = \"pl\"\n  email_from                = \"andrzej@kaczynski.dev\"\n}\n</code></pre> <p>Finally plan &amp; apply the changes</p> <pre><code>$ tofu plan -out plan\n\nOpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:\n  + create\n\nOpenTofu will perform the following actions:\n\n  # proxmox_virtual_environment_cluster_options.options will be created\n  + resource \"proxmox_virtual_environment_cluster_options\" \"options\" {\n      + crs_ha      = (known after apply)\n      + email_from  = \"andrzej@kaczynski.dev\"\n      + id          = (known after apply)\n      + keyboard    = \"pl\"\n      + language    = \"en\"\n      + mac_prefix  = (known after apply)\n    }\n\nPlan: 1 to add, 0 to change, 0 to destroy.\n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nSaved the plan to: plan\n\nTo perform exactly these actions, run the following command to apply:\n    tofu apply \"plan\"\n\n$ tofu apply plan\nproxmox_virtual_environment_cluster_options.options: Creating...\nproxmox_virtual_environment_cluster_options.options: Creation complete after 0s [id=cluster]\n\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\n</code></pre>"},{"location":"software/proxmox-ve/#ansible","title":"Ansible","text":"<p>Because the available OpenTofu providers does not allow to configure everything I want, I need to use Ansible for the rest of the things. I'm going to use the official Provider for Ansible. This is going to be my first time when using it. I hope it will meet my expectations.</p> <p>I've created my ansible role &amp; playbook for manage this part. You can find the source code on my github repo https://github.com/andrewkaczynski/homelab-ansible.</p>"}]}